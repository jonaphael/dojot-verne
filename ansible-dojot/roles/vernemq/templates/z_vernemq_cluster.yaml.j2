apiVersion: vernemq.com/v1alpha1
kind: VerneMQ
metadata:
  labels:
    vernemq: k8s
  name: k8s
  namespace: {{ dojot_namespace }}
spec:
  baseImage: dojot/vernemq-dojot
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: kubernetes.io/hostname
            operator: NotIn
            values:
            - verne-kafka
  env:
    - name: USE_VMQ_OPERATOR
      value: "y"
    - name: PLUGIN_ACL_CHAIN
      value: "n"
    - name: EJBCA_HOSTNAME
      value: "ejbca-wrapper"
    - name: EJBCA_PORT
      value: "5583"
    - name: CRL_UPDATE_TIME
      value: "*/30 * * * *" #every 30 min
    - name: CHECK_EXPIRATION_TIME
      value: "*/30 * * * *" #every 30 min
    - name: CHECK_BROKER_CERT_REVOKED_TIME
      value: "*/30 * * * *" #every 30 min
    - name: CHECKEND_EXPIRATION_SEC
      value: "43200" #12h
    - name: SERVER_HOSTNAME
      value: "{{ dojot_domain_name }}"
      ## BASE-64 config
    - name: VERNEMQ_CONF
      value: "YWNjZXB0X2V1bGEgPSB5ZXMKbWV0YWRhdGFfcGx1Z2luID0gdm1xX3N3YwpsaXN0ZW5lci52bXEuY2x1c3RlcmluZyA9ICRNWV9QT0RfSVA6NDQwNTMKbGlzdGVuZXIuaHR0cC5kZWZhdWx0ID0gMC4wLjAuMDo4ODg4CnBsdWdpbnMudm1xX3Bhc3N3ZCA9IG9mZgpwbHVnaW5zLnZtcV9hY2wgPSBvZmYKcGx1Z2lucy52bXFfazhzLnBhdGggPSAvdmVybmVtcS9wbHVnaW5zL19idWlsZC9kZWZhdWx0CnBsdWdpbnMudm1xX2s4cyA9IG9uCnBsdWdpbnMudm1xX2s4cy5wcmlvcml0eSA9IDMKcGx1Z2lucy5kb2pvdF9kaXNjb25uZWN0X3BsdWdpbi5wYXRoID0gL3Zlcm5lbXEvZG9qb3RfZGlzY29ubmVjdF9wbHVnaW4vZGVmYXVsdApwbHVnaW5zLmRvam90X2Rpc2Nvbm5lY3RfcGx1Z2luID0gb24KcGx1Z2lucy5kb2pvdF9kaXNjb25uZWN0X3BsdWdpbi5wcmlvcml0eSA9IDIKcGx1Z2lucy5kb2pvdF9hY2xfcGx1Z2luLnBhdGggPSAvdmVybmVtcS9kb2pvdF9hY2xfcGx1Z2luL2RlZmF1bHQKcGx1Z2lucy5kb2pvdF9hY2xfcGx1Z2luID0gb24KcGx1Z2lucy5kb2pvdF9hY2xfcGx1Z2luLnByaW9yaXR5ID0gMgpsZXZlbGRiLm1heGltdW1fbWVtb3J5LnBlcmNlbnQgPSAyMApsb2cuY29uc29sZSA9IGNvbnNvbGUKbGlzdGVuZXIubWF4X2Nvbm5lY3Rpb25zID0gMjAwMDAwCmxpc3RlbmVyLm5yX29mX2FjY2VwdG9ycyA9IDEwMAptYXhfb25saW5lX21lc3NhZ2VzID0gMTAwMDAKbGlzdGVuZXIuc3NsLmRlZmF1bHQgPSAwLjAuMC4wOjg4ODMKbGlzdGVuZXIuc3NsLmRlZmF1bHQuY2FmaWxlID0gIC92ZXJuZW1xL2NlcnQvY2EuY3J0Cmxpc3RlbmVyLnNzbC5kZWZhdWx0LmNlcnRmaWxlID0gL3Zlcm5lbXEvY2VydC8kSE9TVE5BTUUuY3J0Cmxpc3RlbmVyLnNzbC5kZWZhdWx0LmtleWZpbGUgPSAvdmVybmVtcS9jZXJ0LyRIT1NUTkFNRS5rZXkKbGlzdGVuZXIuc3NsLmRlZmF1bHQuY3JsZmlsZSA9ICAvdmVybmVtcS9jZXJ0L2NhLmNybApsaXN0ZW5lci5zc2wuZGVmYXVsdC51c2VfaWRlbnRpdHlfYXNfdXNlcm5hbWUgPSBvbgpsaXN0ZW5lci5zc2wuZGVmYXVsdC5yZXF1aXJlX2NlcnRpZmljYXRlID0gb24="
  config:
    configs:
    - name: allow_register_during_netsplit
      value: "on"
    - name: allow_publish_during_netsplit
      value: "on"
    - name: allow_subscribe_during_netsplit
      value: "on"
    - name: allow_unsubscribe_during_netsplit
      value: "on"
    listeners:
    - address: 0.0.0.0
      port: 1883
    - address: 0.0.0.0
      port: 1888
      websocket: true
    plugins: []
  serviceAccountName: vernemq-k8s
  size: {{ dojot_vernemq_mqtt_replicas_to_scale }}
  tag: {{ dojot_verne_version }}

